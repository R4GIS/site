<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Web Scraping on Curso-R</title>
    <link>http://curso-r.com/tags/web-scraping/index.xml</link>
    <description>Recent content in Web Scraping on Curso-R</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>pt-br</language>
    <copyright>Copyright (c) 2016 - 2017, Curso-R; all rights reserved.</copyright>
    <atom:link href="http://curso-r.com/tags/web-scraping/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Web scraping do site da Secretaria de Segurança Pública de São Paulo</title>
      <link>http://curso-r.com/blog/2017/05/19/2017-05-19-scrapper-ssp/</link>
      <pubDate>Fri, 19 May 2017 23:26:00 +0300</pubDate>
      
      <guid>http://curso-r.com/blog/2017/05/19/2017-05-19-scrapper-ssp/</guid>
      <description>&lt;p&gt;Quando eu trabalhei no Núcleo de Estudos da Violência da USP, obter informações da Secretaria de Segurança Pública de São Paulo (SSP) era uma tarefa meio esotérica. Coletávamos os dados de todos os DP’s de São Paulo, que são aproximadamente 100, e, como fazer isso manualmente era demorado, aplicávamos uma solução automática em dois passos. Primeiro &lt;em&gt;raspávamos&lt;/em&gt; o site da SSP em Python&lt;!--, com um script desenvolvido antes da minha entrada,--&gt; e depois rodávamos uma macro em VBA chamada “Mestre Dos Magos”, que era responsável por consolidar as séries históricas em excel. Eu achava o procedimento um pouco hermético porque nenhum deles tinha sido feito por mim ou pela minha equipe, era uma herança que a gente não sabia como consertar se desse algum problema. Para dar um exemplo, no final da minha breve estadia no NEV o script não funcionava mais, então era necessário baixar tudo manualmente.&lt;/p&gt;
&lt;p&gt;Depois dessa época eu nunca mais mexi com esses dados. Eu sempre tive vontade de implementar uma solução em R, mas sempre faltou motivação. Felizmente, na ultima semana minha namorada precisou dos dados da SSP para um trabalho que está fazendo, só que dessa vez o interesse era em todos os 645 municípios do estado de São Paulo nos anos entre 2013 a 2016. Como não há como baixar todas essas informações de uma vez e downloads individuais tomam muito tempo, eu me senti motivado o suficiente para atacar o problema.&lt;!--Pensamos um pouco e construímos um _scrapper_ da SSP em R.--&gt;&lt;/p&gt;
&lt;p&gt;Pra ser sincero, foi bem mais fácil do que eu achei que seria. A construção do programa foi tão simples que cabe até mesmo neste post de blog, mas não é só por isso que ela está aqui. &lt;!--De fato, _scrappers_ não vêm em muitas dificuldades (ou são ou muito fáceis, ou são muito difíceis),--&gt; Esse é um exemplo minimal de todas as fases de construção de um &lt;em&gt;scraper&lt;/em&gt;.&lt;!--e neste post vou mostrar como raspar o site da SSP de São Paulo em R.--&gt;&lt;/p&gt;
&lt;div id=&#34;os-quatro-passos-para-construir-um-scraper&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Os quatro passos para construir um &lt;em&gt;scraper&lt;/em&gt;&lt;/h2&gt;
&lt;p&gt;Em um esquema aproximado, eu acredito que raspar (ou &lt;em&gt;scrappear&lt;/em&gt;) um site pode ser feito em 4 passos:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Defina a página que você quer raspar;&lt;/li&gt;
&lt;li&gt;Identifique &lt;em&gt;exatamente&lt;/em&gt; que requisições que produzem o que você quer;&lt;/li&gt;
&lt;li&gt;Construa um programa que &lt;em&gt;imite&lt;/em&gt; as requisições que você faria manualmente;&lt;/li&gt;
&lt;li&gt;Repita o passo 3. quantas vezes quiser.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Mesmo que existam &lt;em&gt;scrapers&lt;/em&gt; mais complicados, é verdade que seguir esses passos pelo menos te ajuda a chegar mais perto do que você realmente precisará fazer depois.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;defina-o-que-voce-quer&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Defina o que você quer&lt;/h2&gt;
&lt;p&gt;Tanto o NEV quanto a minha namorada tinham interesse nas tabelas que apareciam numa URL específica do site: &lt;a href=&#34;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&#34; class=&#34;uri&#34;&gt;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&lt;/a&gt;. A lógica por trás da divulgação dessas informações é a seguinte: você escolhe um ano, uma localidade geográfica/administrativa e um tipo de informação e ele te devolve uma tabela. Os anos disponíveis são os anos de 2001 a 2017, as localidades são os cruzamentos entre Municípios, Regiões e Delegacias (notando que você sempre pode escolher “Todos”) e os tipos de informação são taxas de delito, ocorrências registradas por ano, ocorrências registradas por mês e produtividade policial. Nesta aplicação vamos procurar contagens de ocorrências registradas por mês.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;identifique-o-que-o-site-faz-por-tras&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Identifique o que o site faz por trás&lt;/h2&gt;
&lt;p&gt;Identificar o que o site faz por trás provavelmente é a fase mais complicada da construção de um &lt;em&gt;scraper&lt;/em&gt;. A dificuldade é que não existe um algoritmo que faça isso pra você. Normalmente eu sigo alguns passos, mas eles exigem uma dose de &lt;em&gt;insight&lt;/em&gt; para funcionar, o que implica que talvez não seja possível seguir todos os passos em sequência.&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Entre na página imediatamente anterior à página que você quer acessar.&lt;/li&gt;
&lt;li&gt;Abra as ferramentas de desenvolvedor dos seu navegador (isso normalmente é equivalente à “aperte F12”).&lt;/li&gt;
&lt;li&gt;Selecione a aba “Network” (ou “Rede”) na caixa de ferramentas do desenvolvedor.&lt;/li&gt;
&lt;li&gt;Vá para a página que você quer.&lt;/li&gt;
&lt;li&gt;Na lista de requisições que o site fez ao servidor, identifique aquela(s) que é(são) relevante(s) a sua pesquisa.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Parece muito louco né? No geral, é muito louco sim, mas quando você dá sorte é fácil. Vou mostrar o que acontece no nosso exemplo:&lt;/p&gt;
&lt;div id=&#34;a-pagina-imediatamente-anterior&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;A página imediatamente anterior&lt;/h3&gt;
&lt;p&gt;Eu quero a url &lt;a href=&#34;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&#34; class=&#34;uri&#34;&gt;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&lt;/a&gt; com alguma seleção, então pra realizar o primeiro passo basta entrar em &lt;a href=&#34;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&#34; class=&#34;uri&#34;&gt;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;ferramentas-do-desenvolvedor-e-aba-network&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Ferramentas do desenvolvedor e aba “Network”&lt;/h3&gt;
&lt;p&gt;Em qualquer navegador, as ferramentas do desenvolvedor mostram o &lt;em&gt;background&lt;/em&gt; do que aparece na tela. Se estiver nessa aba, quando você entrar em &lt;a href=&#34;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&#34; class=&#34;uri&#34;&gt;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&lt;/a&gt; e apertar F5, vai encontrar uma tela mais ou menos parecida com a tela abaixo:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-1-1.png&#34; width=&#34;768&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Cada linha representa uma requisição, que é essencialmente o envio de um arquivo .html ao servidor. O conteúdo que visualizamos na tela é o resultado de todas essas requisições e, se destrincharmos cada uma delas, podemos identificar aquelas que são relevantes para o nosso problema.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;a-requisicao&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;A requisição&lt;/h3&gt;
&lt;p&gt;O próximo passo é identificar o que é que o navegador pede ao servidor quando te devolve o que você quer. Se você escolher o ano de 2017 na caixa de seleção de anos, por exemplo, vai encontrar uma tela parecida com essa aqui.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-2-1.png&#34; width=&#34;768&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Antes de prosseguir, é necessário fazer uma inspeção meticulosa de todas as requisições que aparecem, mas vou encurtar a discussão afirmando que a primeira delas é a mais importante. Existem muitas maneiras de deduzir que ela é uma boa candidata, como por exemplo olhando que ela é a única requisição &lt;em&gt;relevante&lt;/em&gt; que recebe html, mas vou pular essa parte.&lt;/p&gt;
&lt;p&gt;Segundo o nosso dedo duro, a requisição utiliza o método “POST” e, quando clicamos nela, temos informações sobre ela no painel ao lado. Como eu falei acima, uma requisição é um arquivo .html que “pede” alguma ao servidor com base no seu conteúdo. No geral, um bom lugar para procurar o que a requisição está pedindo é o seu conjunto de parâmetros, na aba “Params” do painel de detalhamento da requisição.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-3-1.png&#34; width=&#34;768&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Quando inspecionamos essa requisição “POST”, identificamos que as coisas que são relevantes para o conteúdo da página estão nesses parâmetros. De fato, pensando ingenuamente, clicar apenas em “2017” deve mexer nos parâmetros que tem a ver com isso mas deve deixar os demais parâmetros fixos. Por sorte, os parâmetros observados batem com essa expectativa: “__EVENTTARGET&amp;quot; é &lt;code&gt;ctl00$conteudo$$ddlAnos&lt;/code&gt; é um &lt;em&gt;placeholder&lt;/em&gt; que tem a ver com a caixa de seleção em que mexemos, os dois próximos parâmetros estão zerados, “__VIEWSTATE&amp;quot; e “__EVENTVALIDATION&amp;quot; são parâmetros da sessão, e, por fim, temos os parâmetros da consulta, que estão todos zerados com exceção de &lt;code&gt;ctl00$conteudo$$ddlAnos&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Parece que os parâmetros tem tudo a ver com a saída. Será que mexer apenas neles basta para copiar a requisição do navegador?&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;crie-um-robo-que-imita-o-que-um-humano-faria&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Crie um robô que imita o que um humano faria&lt;/h2&gt;
&lt;p&gt;Agora que sabemos um pouco mais sobre como as requisições funcionam, vamos tentar fazer o POST mais simples de todos: ele só tem os parâmetros da última imagem. Em R, o jeito mais fácil de fazer requisições é usando o pacote &lt;code&gt;httr&lt;/code&gt;. Ele é bem intuitivo e flexível, de tal forma que fazer um POST é feito simplesmente chamando a função &lt;code&gt;httr::POST&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;url &amp;lt;- &amp;#39;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&amp;#39;
#código para dar um POST vazio no site
httr::POST(url)
#o resultado é simplesmente o resultado original da página&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Para colocar parâmetros num POST, basta usar o parâmetro &lt;code&gt;body&lt;/code&gt;. Antes de complicar, vamos tentar o conjunto de parâmetros mais simples de todos: vamos ignorar tudo que a gente não sabe exatamente o que é e preencher só o que sabemos:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;params &amp;lt;- list(`__EVENTTARGET` = &amp;quot;ctl00$conteudo$$ddlAnos&amp;quot;,
               `__EVENTARGUMENT` = &amp;quot;&amp;quot;,
               `__LASTFOCUS` = &amp;quot;&amp;quot;,
               `__VIEWSTATE` = &amp;quot;&amp;quot;,
               `__EVENTVALIDATION` = &amp;quot;&amp;quot;,
               `ctl00$conteudo$ddlAnos` = &amp;quot;2015&amp;quot;,
               `ctl00$conteudo$ddlRegioes` = &amp;quot;0&amp;quot;,
               `ctl00$conteudo$ddlMunicipios` = &amp;quot;0&amp;quot;,
               `ctl00$conteudo$ddlDelegacias` = &amp;quot;0&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Agora vamos fazer a requisição. O passo seguinte é apenas pra traduzir o resultado pra um formato mais fácil de mexer.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;resposta &amp;lt;- httr::POST(url,
                       body = params,
                       encode = &amp;#39;form&amp;#39;) %&amp;gt;% 
    xml2::read_html()
    # traduz o resultado&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Como vamos saber se deu certo? Existem vários jeitos, mas, por simplicidade, aqui vamos apenas checar se alguma tabela contida em &lt;code&gt;resposta&lt;/code&gt; é igual à tabela que extraímos manualmente do site. Vamos fazer isso usando a função &lt;code&gt;rvest::html_table()&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;resposta %&amp;gt;% 
  rvest::html_table()
# extrai todas as tabelas de um código em html.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Como se vê acima, nada que &lt;em&gt;se parece&lt;/em&gt; com uma tabela na resposta da nossa requisição é a tabelinha que identificamos no site. Muita coisa pode ter dado errado, mas vamos começar pelo que é mais evidente: nós ignoramos os parâmetros &lt;code&gt;__VIEWSTATE&lt;/code&gt; e &lt;code&gt;__EVENTVALIDATION&lt;/code&gt;. Em última instância, nos vamos precisar &lt;em&gt;entender&lt;/em&gt; o que esses parâmetros significam, mas primeiro vamos tentar simplesmente obter uma cópia desses valores diretamente do site. Dando um ctrl+f no painel de ferramentas de desenvolvedor identificamos que o valores dessa variáveis sai de umas tags &lt;code&gt;input&lt;/code&gt; nomeadas de acordo com o parâmetro que representam.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;view_state &amp;lt;- httr::POST(url) %&amp;gt;% 
  xml2::read_html() %&amp;gt;% 
  rvest::html_nodes(&amp;quot;input[name=&amp;#39;__VIEWSTATE&amp;#39;]&amp;quot;) %&amp;gt;% 
  rvest::html_attr(&amp;quot;value&amp;quot;)

event_validation &amp;lt;- httr::POST(url) %&amp;gt;% 
  xml2::read_html() %&amp;gt;% 
  rvest::html_nodes(&amp;quot;input[name=&amp;#39;__EVENTVALIDATION&amp;#39;]&amp;quot;) %&amp;gt;% 
  rvest::html_attr(&amp;quot;value&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Com os nossos embustes em mãos, basta pular para a próxima etapa: tentar simular um clique no site. Nosso novo conjunto de parâmetros fica:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;params &amp;lt;- list(`__EVENTTARGET` = &amp;quot;ctl00$conteudo$$ddlAnos&amp;quot;,
               `__EVENTARGUMENT` = &amp;quot;&amp;quot;,
               `__LASTFOCUS` = &amp;quot;&amp;quot;,
               `__VIEWSTATE` = view_state,
               `__EVENTVALIDATION` = event_validation,
               `ctl00$conteudo$ddlAnos` = &amp;quot;2015&amp;quot;,
               `ctl00$conteudo$ddlRegioes` = &amp;quot;0&amp;quot;,
               `ctl00$conteudo$ddlMunicipios` = &amp;quot;0&amp;quot;,
               `ctl00$conteudo$ddlDelegacias` = &amp;quot;0&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;E o código da requisição fica:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;resposta &amp;lt;- httr::POST(url,
                       body = params,
                       encode = &amp;#39;form&amp;#39;) %&amp;gt;% 
    xml2::read_html() %&amp;gt;% 
  rvest::html_table()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Exatamente a tabelinha que queríamos! Entretanto, nem tudo são flores. Como eu mencionei ali em cima, tanto a minha namorada quanto o NEV tinham interesse no número de BO’s, que não é o que obtivemos fazendo a requisição via R. Fuçando um pouco, é fácil ver que o que obtivemos são os números de produtividade policial. Será que é fácil mexer nos parâmetros pra obter os números de BO’s?&lt;/p&gt;
&lt;p&gt;Felizmente, a resposta é sim, mas não é tão simples quanto parece. Se de outra tela qualquer você clicar em “Ocorrências Registradas por Mês” você vai perceber que o “__EVENTTARGET&amp;quot; mudou para &lt;code&gt;ctl00$conteudo$$btnMes&lt;/code&gt;, mas, a despeito do que se poderia imaginar, os outros parâmetros permaneceram com os nomes intactos.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-11-1.png&#34; width=&#34;768&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Como essa requisição sugere, você consegue variar os tipos de informação simplesmente variando o “__EVENTTARGET“. Com isso, uma requisição para obter as”Ocorrências Registradas por Mês&amp;quot; ficaria:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;params &amp;lt;- list(`__EVENTTARGET` = &amp;quot;ctl00$conteudo$$ddlAnos&amp;quot;,
               `__EVENTARGUMENT` = &amp;quot;&amp;quot;,
               `__LASTFOCUS` = &amp;quot;&amp;quot;,
               `__VIEWSTATE` = view_state,
               `__EVENTVALIDATION` = event_validation,
               `ctl00$conteudo$ddlAnos` = &amp;quot;2015&amp;quot;,
               `ctl00$conteudo$ddlRegioes` = &amp;quot;0&amp;quot;,
               `ctl00$conteudo$ddlMunicipios` = &amp;quot;0&amp;quot;,
               `ctl00$conteudo$ddlDelegacias` = &amp;quot;0&amp;quot;)

resposta &amp;lt;- httr::POST(url,
                       body = params,
                       encode = &amp;#39;form&amp;#39;) %&amp;gt;% 
    xml2::read_html()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;É importante notar que cada vez que vamos um POST desse, é como se estivessemos entrando na página novamente, de tal forma que as informações que a página tem quando damos vários cliques seguidos são diferentes das informações de quando acessamos a página pelo R. Por exemplo, quando estamos navegando pela página pelos links, o “__EVENTTARGET&amp;quot; volta para &lt;code&gt;ctl00$conteudo$$ddlAnos&lt;/code&gt; se você trocar de página &lt;em&gt;saindo&lt;/em&gt; de uma página de “Ocorrências Registradas por Mês”, mas o tipo de informação vêm corretamente. Isso acontece porque, se você acessar várias páginas em sequência, a página sabe de onde você veio.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;repita-quantas-vezes-quiser&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Repita quantas vezes quiser&lt;/h2&gt;
&lt;p&gt;Agora vem a repetição, o passo final da raspagem. Antes de qualquer coisa precisamos de duas pequenas generalizações: queremos baixar vários anos e vários municípios. Isso é fácil de fazer pois os índices dos municípios são as suas posições em ordem alfabética. Dessa forma, é possível fazer uma função que baixa as “Ocorrências Registradas por Mês” de um município em um determinado ano:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;baixa_bo_municipio_ano &amp;lt;- function(ano, municipio){
pivot &amp;lt;- httr::GET(url)
#serve apenas para pegarmos um view_state e um event_validation valido
  
view_state &amp;lt;- pivot %&amp;gt;% 
  xml2::read_html() %&amp;gt;% 
  rvest::html_nodes(&amp;quot;input[name=&amp;#39;__VIEWSTATE&amp;#39;]&amp;quot;) %&amp;gt;% 
  rvest::html_attr(&amp;quot;value&amp;quot;)

event_validation &amp;lt;- pivot %&amp;gt;% 
  xml2::read_html() %&amp;gt;% 
  rvest::html_nodes(&amp;quot;input[name=&amp;#39;__EVENTVALIDATION&amp;#39;]&amp;quot;) %&amp;gt;% 
  rvest::html_attr(&amp;quot;value&amp;quot;)

params &amp;lt;- list(`__EVENTTARGET` = &amp;quot;ctl00$conteudo$$btnMes&amp;quot;,
             `__EVENTARGUMENT` = &amp;quot;&amp;quot;,
             `__LASTFOCUS` = &amp;quot;&amp;quot;,
             `__VIEWSTATE` = view_state,
             `__EVENTVALIDATION` = event_validation,
             `ctl00$conteudo$ddlAnos` = &amp;quot;2015&amp;quot;,
             `ctl00$conteudo$ddlRegioes` = &amp;quot;0&amp;quot;,
             `ctl00$conteudo$ddlMunicipios` = municipio,
             `ctl00$conteudo$ddlDelegacias` = &amp;quot;0&amp;quot;)

 httr::POST(url, body = params, encode = &amp;#39;form&amp;#39;) %&amp;gt;% 
  xml2::read_html() %&amp;gt;% 
  rvest::html_table() %&amp;gt;% 
  dplyr::first() %&amp;gt;% 
  #&amp;#39; serve pra pegar apenas a primeira tabela da página,
  #&amp;#39; se houver mais do que uma. Estou assumindo que a 
  #&amp;#39; tabela que eu quero é sempre a primeira.
  dplyr::mutate(municipio = municipio,
                ano = ano) 
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Pra ilustar um grande loop, vamos baixar os BO’s de todos os municípios, no ano de 2016. A função demora um pouco pra rodar, então quem quiser ver como fica o resultado final pode clicar &lt;a href=&#34;https://github.com/curso-r/site/blob/master/content/blog/2017-05-19-scrapper-ssp/dados_ssp.rds&#34;&gt;neste link&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;GRID &amp;lt;- expand.grid(municipio = 1:645, ano = &amp;#39;2016&amp;#39;, stringsAsFactors = F)

D &amp;lt;- purrr::by_row(GRID, baixa_bo_municipio_ano, .to = &amp;quot;ocorrencias&amp;quot;) %&amp;gt;% 
  tidyr::unnest(ocorrencias)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;resultados&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Resultados&lt;/h2&gt;
&lt;p&gt;Com esses dados dá pra fazer muitas coisas legais. É possível, por exemplo, fazer mapas como esse, que representa o número de homicídios em 2016, por município. Ele foi feito em R, mas como fazê-lo é assunto pra outro post!&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-15-1.png&#34; width=&#34;672&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Lollapalooza segundo Spotify - Web Scraping, API do Spotify e tidyverse</title>
      <link>http://curso-r.com/blog/2017/03/27/2017-03-27-lollapalooza-sp-2017-segundo-spotify/</link>
      <pubDate>Mon, 27 Mar 2017 00:00:00 +0000</pubDate>
      
      <guid>http://curso-r.com/blog/2017/03/27/2017-03-27-lollapalooza-sp-2017-segundo-spotify/</guid>
      <description>&lt;p&gt;No dia em que fui ao Lollapalooza eu descobri o &lt;a href=&#34;https://github.com/tiagomendesdantas/Rspotify&#34;&gt;Rspotify&lt;/a&gt;, um wraper da API do Spotify e daí me veio a ideia de juntar infos dos dois assuntos.&lt;/p&gt;
&lt;p&gt;A brincadeira aqui vai envolver&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Web Scraping - para baixar e estruturar as tabelas de programação do Lolapalooza SP 2017&lt;/li&gt;
&lt;li&gt;API do Spotify - por meio do pacote Rspotify&lt;/li&gt;
&lt;li&gt;todos os pacotes do tidyverse&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Lollapalooza deste ano em São Paulo contou com 47 bandas distribuídas em quatro palcos. A graça é associar a programação do Lolla com as informações de popularidade das bandas fornecidas pelo Spotify. Abaixo eu vou descrever como peguei os dados, listar as três hipóteses que criei e gerar alguns gráficos pra discutí-las.&lt;/p&gt;
&lt;div id=&#34;base-de-dados&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Base de dados&lt;/h2&gt;
&lt;div id=&#34;pre-requisitos&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Pré-requisitos&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Pacotes&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# instala o Rspotify
if(!require(&amp;quot;Rspotify&amp;quot;))
  devtools::install_github(&amp;quot;tiagomendesdantas/Rspotify&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(Rspotify)
library(magrittr)
library(forcats)
library(stringi)
library(lubridate)
library(httr)
library(rvest)
library(tidyverse)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;O &lt;code&gt;Rspotify&lt;/code&gt; é um pacote novo e que ainda não está no CRAN, mas já está funcional.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Conta no Spotify&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Para utilizar a API do Spotify é necessário ter um cadastro no site deles, como se pode imaginar.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;App no Spotify&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Para você receber um código de acesso para usar a API deles é preciso criar um &lt;em&gt;App&lt;/em&gt; dentro da sua conta do Spotify, esse é o pré-requisito mais burocrático de todos. Eu aprendi a fazer isso seguindo os passos do README do próprio pacote &lt;code&gt;Rspotify&lt;/code&gt; no Github &lt;a href=&#34;https://github.com/tiagomendesdantas/Rspotify&#34;&gt;(veja aqui)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;No fim, você terá um &lt;code&gt;app_id&lt;/code&gt;, um &lt;code&gt;client_id&lt;/code&gt; e um &lt;code&gt;client_secret&lt;/code&gt; em mãos.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;extraindo-programacao-do-lollapalooza-sp-2017&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Extraindo programação do Lollapalooza SP 2017&lt;/h3&gt;
&lt;p&gt;O objetivo aqui é termos uma versão em &lt;code&gt;data.frame&lt;/code&gt; das tabelas contidas no site &lt;a href=&#34;https://www.lollapaloozabr.com/lineup-horarios/&#34;&gt;lollapaloozabr.com/lineup-horarios/&lt;/a&gt;. Lá tem a agenda completa dos dois dias do evento.&lt;/p&gt;
&lt;p&gt;Vamos ao código! Dica: a melhor maneira de aprender o que cada passo do código faz é ir rodando linha a linha e observando o resultado.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# programacao do site do lollapalooza 2017 ----------------------

lolla2017_programacao &amp;lt;- &amp;quot;https://www.lollapaloozabr.com/lineup-horarios/&amp;quot; %&amp;gt;%
  GET() %&amp;gt;% 
  read_html() %&amp;gt;%
  html_table() %&amp;gt;%
  set_names(c(&amp;quot;sabado&amp;quot;, &amp;quot;domingo&amp;quot;)) %&amp;gt;%
  at_depth(2, ~ .x %&amp;gt;% 
             stri_replace_all_regex(&amp;quot; {2,}&amp;quot;, &amp;quot;&amp;quot;) %&amp;gt;% 
             stri_replace_all_regex(&amp;quot;[\\n]{1}&amp;quot;, &amp;quot;,&amp;quot;) %&amp;gt;% 
             stri_replace_all_regex(&amp;quot;[,]{2,}&amp;quot;, &amp;quot;\\\n&amp;quot;) %&amp;gt;% 
             read.csv(text = ., header = FALSE, 
                      col.names = c(&amp;quot;artist&amp;quot;, &amp;quot;hora&amp;quot;))) %&amp;gt;%
  map(~ .x[-1] %&amp;gt;% 
        data_frame(palco = names(.), programacao_palco = .) %&amp;gt;% 
        unnest(programacao_palco)) %&amp;gt;%
  data_frame(dia = names(.), programacao = .) %&amp;gt;%
  unnest(programacao) %&amp;gt;%
  separate(hora, c(&amp;quot;hora_ini&amp;quot;, &amp;quot;hora_fim&amp;quot;), sep = &amp;quot;-&amp;quot;) %&amp;gt;%
  mutate(artist = artist %&amp;gt;% tolower,
         hora_ini = paste(if_else(dia %in% &amp;quot;sabado&amp;quot;, &amp;quot;2017-03-25&amp;quot;, &amp;quot;2017-03-26&amp;quot;), hora_ini) %&amp;gt;% ymd_hm(),
         hora_ini = if_else(hour(hora_ini) &amp;lt; 12, hora_ini + hours(12), hora_ini),
         hora_fim = paste(if_else(dia %in% &amp;quot;sabado&amp;quot;, &amp;quot;2017-03-25&amp;quot;, &amp;quot;2017-03-26&amp;quot;), hora_fim) %&amp;gt;% ymd_hm(),
         hora_fim = if_else(hour(hora_fim) &amp;lt; 12, hora_fim + hours(12), hora_fim),
         dia = fct_relevel(dia, c(&amp;quot;sabado&amp;quot;, &amp;quot;domingo&amp;quot;)))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Resultado&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;dia&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;palco&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;artist&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;hora_ini&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;hora_fim&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;cage the elephant&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 16:25:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 17:25:00&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;metallica&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 21:00:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 23:00:00&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;doctor pheabes&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 12:05:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 13:05:00&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;rancid&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 18:35:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 19:35:00&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;suricato&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 14:15:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 15:15:00&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Onix&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;the 1975&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 17:30:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 18:30:00&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Onix&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;the outs&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 13:10:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 14:10:00&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Onix&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;the xx&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 19:40:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 20:55:00&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;É interessante reparar que para gerar essa simples tabelinha utilizamos os pacotes &lt;code&gt;httr&lt;/code&gt;, &lt;code&gt;rvest&lt;/code&gt;, &lt;code&gt;purrr&lt;/code&gt;, &lt;code&gt;dplyr&lt;/code&gt;, &lt;code&gt;tidyr&lt;/code&gt;, &lt;code&gt;lubridate&lt;/code&gt;, &lt;code&gt;stringi&lt;/code&gt; e &lt;code&gt;forcats&lt;/code&gt;. Só faltou o &lt;code&gt;ggplot2&lt;/code&gt; para zerar o tidyverse.&lt;/p&gt;
&lt;p&gt;OBS: 89 fm não é uma banda, era só um espaço reservado para fins de publicidade da rádio.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;extraindo-a-popularidade-das-bandas-do-lollapalooza-no-spotify&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Extraindo a popularidade das bandas do Lollapalooza no Spotify&lt;/h3&gt;
&lt;p&gt;Agora vamos usar o pacote &lt;code&gt;Rspotify&lt;/code&gt; para extrair as popularidades das bandas que estão listadas no data.frame &lt;code&gt;lolla2017_programacao&lt;/code&gt;. Para tanto, usei uma playlist oficial no Spotify feita pela própria equipe do Lollapalooza. Essa playlist é identificada pelo id &lt;code&gt;1mHoPn6JpbtWtoBuvSXrVm&lt;/code&gt; lá no banco de dados do Spotify.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;meu_token &amp;lt;- spotifyOAuth(app_id, client_id, client_secret) # coloque aqui suas infos fornecidas pelo Spotify.&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;lolla2017_playlist &amp;lt;- getPlaylistSongs(&amp;quot;lollabr&amp;quot;, &amp;quot;1mHoPn6JpbtWtoBuvSXrVm&amp;quot;, token = meu_token) %&amp;gt;%
  mutate(artistInfo = map(artistId, getArtistinfo),
         artist = artist %&amp;gt;% tolower) %&amp;gt;%
  rename(track_popularity = popularity,
         track_id = id) %&amp;gt;%
  unnest(artistInfo) %&amp;gt;%
  select(artist, id, name, popularity, followers)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Algumas bandas ficaram de fora da playlist e por isso fiz uma pesquisa por nome do artista na própria API do Spotify para recuperar o respectivo id. A função que faz isso é a &lt;code&gt;searchArtist()&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# recuperando infos dos artistas esquecidos pela playlist ----------------------

possibly_searchArtist &amp;lt;- possibly(searchArtist, NA_character_)

artistas_fora_da_playlist &amp;lt;- lolla2017_programacao %&amp;gt;% 
  filter(!artist %in% lolla2017_playlist$artist) %$% 
  artist %&amp;gt;% 
  data_frame(artist = .) %&amp;gt;%
  mutate(search_artist = map(artist, ~ .x %&amp;gt;% possibly_searchArtist),
         artist_info = map2(search_artist, artist, ~ {
           if(.x %&amp;gt;% is.na) {data.frame(search_artist = NA)} else {
           .x %&amp;gt;%
             mutate(name = name %&amp;gt;% tolower) %&amp;gt;%
             filter(name %in% .y) %&amp;gt;%
             head(1)
         }})) %&amp;gt;%
  select(-search_artist) %&amp;gt;%
  unnest(artist_info) %&amp;gt;%
  select(artist, id, name, popularity, followers) &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Resultado&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;artist&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;id&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;name&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;popularity&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;followers&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;ricci&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;1EUMh6DZo2CfpolG75YQBL&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;ricci&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;49&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;6116&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;jimmy eat world&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;3Ayl7mCk0nScecqOzvNp6s&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;jimmy eat world&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;66&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;361785&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;89 fm&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;NA&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;NA&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;NA&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;NA&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;martin garrix&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;60d24wfXkVzDSfLS6hyCjZ&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;martin garrix&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;85&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2244761&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;illusionize&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;3RloA7E4XMItSP4FjMBv3L&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;illusionize&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;46&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;30054&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div id=&#34;juntando-tudo&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Juntando tudo&lt;/h3&gt;
&lt;p&gt;Agora vamos juntar a programação do Lolla com as infos do Spotify. A chave é &lt;code&gt;artist&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;lolla2017 &amp;lt;- left_join(lolla2017_programacao,
                       lolla2017_playlist %&amp;gt;% bind_rows(artistas_fora_da_playlist),
                       by = &amp;quot;artist&amp;quot;) %&amp;gt;%
  select(-id, -name) %&amp;gt;%
  dplyr::filter(followers %&amp;gt;% is.na %&amp;gt;% not) &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Base final&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;dia&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;palco&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;artist&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;hora_ini&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;hora_fim&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;popularity&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;followers&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;cage the elephant&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 16:25:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 17:25:00&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;72&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;745453&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;metallica&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 21:00:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 23:00:00&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;80&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;3047126&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;doctor pheabes&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 12:05:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 13:05:00&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;20&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;313&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;rancid&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 18:35:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 19:35:00&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;60&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;220182&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Skol&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;suricato&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 14:15:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 15:15:00&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;41&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;52326&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Onix&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;the 1975&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 17:30:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 18:30:00&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;77&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1600845&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Onix&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;the outs&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 13:10:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 14:10:00&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;28&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;3788&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;sabado&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Palco Onix&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;the xx&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 19:40:00&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;2017-03-25 20:55:00&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;76&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2383923&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;resultados&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Resultados&lt;/h2&gt;
&lt;div id=&#34;hipotese-i&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Hipótese I&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Hipótese I:&lt;/strong&gt; a organização usou a estratégia de distribuir a popularidade das bandas uniformemente no dia.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Um dos vários desafios logísticos que o evento tem é a alocação das bandas na grade horária nos quatro diferentes palcos.&lt;/p&gt;
&lt;p&gt;Eu fui no evento no sábado e ouvi falar que a banda &lt;em&gt;Cage The Elephant&lt;/em&gt; tinha sido uma das primeiras bandas a se apresentar. Sabia da popularidade da banda (segundo o Spotify, está mais popular do que &lt;em&gt;The Strokes&lt;/em&gt;) e na hora estranhei a decisão do evento de colocá-los para tocar tão cedo.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;lolla2017_grafico &amp;lt;- lolla2017 %&amp;gt;%
  mutate(hora = map2(hora_ini, hora_fim, ~ seq(.x, .y, 30*60) %&amp;gt;% floor_date(&amp;quot;30 minutes&amp;quot;))) %&amp;gt;%
  unnest(hora) %&amp;gt;%
  group_by(dia, hora, palco) %&amp;gt;%
  summarise(artist = first(artist),
            n = n(),
            mean_popularity = mean(popularity))

lolla2017_grafico %&amp;gt;%
  ggplot(aes(x = ymd_hm(format(hora, &amp;quot;2017-03-26 %H%M&amp;quot;)), y = mean_popularity, colour = palco)) +
  geom_line() +
  geom_point() +
  geom_point(data = lolla2017_grafico %&amp;gt;% filter(artist %in% &amp;quot;cage the elephant&amp;quot;), colour = &amp;quot;red&amp;quot;, size = 2) +
  geom_text(data = lolla2017_grafico %&amp;gt;% filter(artist %in% &amp;quot;cage the elephant&amp;quot;) %&amp;gt;% head(1), aes(label = artist), colour = &amp;quot;red&amp;quot;, hjust = 0, vjust = -1) +
  facet_wrap(~dia) +
  labs(x = &amp;quot;Hora do dia&amp;quot;, y = &amp;quot;Popularidade média&amp;quot;) +
  theme(text = element_text(size = 16))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-03-27-lollapalooza-sp-2017-segundo-spotify_files/figure-html/unnamed-chunk-12-1.png&#34; width=&#34;864&#34; /&gt;&lt;/p&gt;
&lt;p&gt;O gráfico acima vai de acordo com o senso comum de que os populares ficam para o final, não ajudando a confirmar a hipótese de que o &lt;em&gt;Cage The Elefant&lt;/em&gt; estava mal posicionado.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;hipotese-ii&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Hipótese II&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Hipótese II:&lt;/strong&gt; em termos de popularidade das bandas, o dia de domingo estava melhor do que o dia de sábado.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Em conversas com amigos e conhecidos reparei que a maioria ou iria no domingo ou preferiria ir no domingo caso tivesse oportunidade. Isso me fez levantar a dúvida se realmente havia maior concentração de bandas boas no domingo.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(lolla2017 %&amp;gt;%
         mutate(artist = artist %&amp;gt;% fct_reorder(popularity, .desc = TRUE))) +
  geom_bar(aes(x = artist, y = popularity, fill = dia), stat = &amp;quot;identity&amp;quot;, position = &amp;quot;dodge&amp;quot;) +
  theme(text = element_text(size = 16),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-03-27-lollapalooza-sp-2017-segundo-spotify_files/figure-html/unnamed-chunk-13-1.png&#34; width=&#34;864&#34; /&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(lolla2017) +
 geom_density(aes(fill = dia, x = popularity, colour = dia), fill = NA) +
  theme(text = element_text(size = 16),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-03-27-lollapalooza-sp-2017-segundo-spotify_files/figure-html/unnamed-chunk-14-1.png&#34; width=&#34;864&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Conclusão: nada indica que houve desbalanceamento. Acho que meu círculo de amigos tem algum viés estranho.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;hipotese-iii&#34; class=&#34;section level3&#34;&gt;
&lt;h3&gt;Hipótese III&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Hipótese III:&lt;/strong&gt; a popularidade das bandas nos diferentes palcos estava equilibrada.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Quando me questionei da hipótese I também pensei na dificuldade de posicionar as bandas nos diferentes palcos. Já que teriam milhares de pessoas disputando espaço, seria do interesse da organização deixá-los o mais espalhado possível por vários motivos: melhor fluxo das filas, maior conforto, menos risco de acidentes, entre outros, e um bom jeito de fazer isso seria deixando os palcos igualmente atrativos para não haver uma grande aglomeração em um único ponto.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(lolla2017 %&amp;gt;%
         mutate(palco = palco %&amp;gt;% as.factor %&amp;gt;% fct_reorder(popularity, mean))) +
  geom_boxplot(aes(fill = palco, y = popularity, x = 1)) +
  theme(text = element_text(size = 16),
        axis.text.x = element_blank()) +
  labs(x = &amp;quot;&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;http://curso-r.com/blog/2017-03-27-lollapalooza-sp-2017-segundo-spotify_files/figure-html/unnamed-chunk-15-1.png&#34; width=&#34;864&#34; /&gt;&lt;/p&gt;
&lt;p&gt;O palco Skol teve menor variação de popularidade, costumou contar sempre com artistas de média a alta popularidade, mas os palcos AXE e Onix foram visitados por artista de peso. O palco Perry’s foi o mais visitado por artistas de menor expressão.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;consideracoes-finais&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Considerações finais&lt;/h2&gt;
&lt;p&gt;O tema tratado aqui não foi útil, concordo, mas passamos por quase todas as etapas existentes em um processo típico de análise de dados. Fizemos web scraping, usamos APIs, arrumamos os dados, estruturamos as informações, criamos variáveis e geramos gráficos. Só ficou de fora a parte de modelagem. E não à toa todos os pacotes do tidyverse foram úteis nesse trabalho.&lt;/p&gt;
&lt;p&gt;A lição pra casa é encontrar uns dados interessantes na internet e aplicar as etapas que aprendemos aqui!&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>